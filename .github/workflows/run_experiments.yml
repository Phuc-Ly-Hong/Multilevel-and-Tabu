name: Run Experiments (Matrix - Fast)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ‚úÖ JOB 1: COMPILE (1 l·∫ßn)
  compile:
    name: Compile C++
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++
    
    - name: Compile executable
      run: |
        g++ -O2 -std=c++17 -o multilevel_tabu src/Multilevel_Tabu.cpp
        chmod +x multilevel_tabu
        ls -lh multilevel_tabu
    
    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: multilevel-executable
        path: multilevel_tabu
        retention-days: 1

  # ‚úÖ JOB 2: SMALL INSTANCES (6-20 nodes) - NHANH
  run-small:
    name: Small ${{ matrix.instance }}
    needs: compile
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    strategy:
      fail-fast: false
      max-parallel: 12  # Ch·∫°y nhi·ªÅu c√πng l√∫c v√¨ nhanh
      matrix:
        instance: [
          "10.5.1", "10.5.2", "10.5.3", "10.5.4",
          "10.10.1", "10.10.2", "10.10.3", "10.10.4",
          "10.20.1", "10.20.2", "10.20.3", "10.20.4",
          "20.5.1", "20.5.2", "20.5.3", "20.5.4",
          "20.10.1", "20.10.2", "20.10.3", "20.10.4",
          "20.20.1", "20.20.2", "20.20.3", "20.20.4"
        ]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download executable
      uses: actions/download-artifact@v4
      with:
        name: multilevel-executable
    
    - name: Run instance
      run: |
        chmod +x multilevel_tabu
        timeout 8m ./multilevel_tabu instances/${{ matrix.instance }}.txt > output.txt 2>&1 || true
        echo "=== EXECUTION COMPLETE ==="
    
    - name: Parse results
      run: |
        python3 <<'EOF'
        import re, json
        
        instance = "${{ matrix.instance }}"
        
        try:
            with open("output.txt", "r") as f:
                content = f.read()
            
            makespan = 0.0
            drone_viol = 0.0
            waiting_viol = 0.0
            fitness = 0.0
            
            # ‚úÖ T√åM SECTION CU·ªêI C√ôNG "Route details:"
            last_route_section = content.rfind("Route details:")
            
            if last_route_section != -1:
                # ‚úÖ CH·ªà PARSE PH·∫¶N SAU "Route details:" cu·ªëi c√πng
                final_section = content[last_route_section:]
                
                lines = final_section.split('\n')
                
                for line in lines:
                    if "Makespan:" in line:
                        m = re.search(r'Makespan:\s*([\d.]+)', line)
                        if m: 
                            makespan = float(m.group(1))
                            print(f"  Found Makespan: {makespan}")
                    
                    elif "Drone violation:" in line:
                        m = re.search(r'Drone violation:\s*([\d.]+)', line)
                        if m: 
                            drone_viol = float(m.group(1))
                            print(f"  Found Drone violation: {drone_viol}")
                    
                    elif "Waiting violation:" in line:
                        m = re.search(r'Waiting violation:\s*([\d.]+)', line)
                        if m: 
                            waiting_viol = float(m.group(1))
                            print(f"  Found Waiting violation: {waiting_viol}")
                    
                    elif "Fitness:" in line:
                        m = re.search(r'Fitness:\s*([\d.]+)', line)
                        if m: 
                            fitness = float(m.group(1))
                            print(f"  Found Fitness: {fitness}")
            else:
                print("‚ö†Ô∏è  'Route details:' not found in output!")
            
            # ‚úÖ VALIDATION: Fitness ph·∫£i >= Makespan
            expected_fitness = makespan + 10000*drone_viol + 10*waiting_viol
            
            if abs(fitness - expected_fitness) > 0.01:
                print(f"‚ö†Ô∏è  WARNING: Fitness mismatch!")
                print(f"   Parsed: {fitness}")
                print(f"   Expected: {expected_fitness}")
                print(f"   (Makespan={makespan} + 10000*{drone_viol} + 10*{waiting_viol})")
                
                # ‚úÖ FIX: D√πng gi√° tr·ªã t√≠nh to√°n
                fitness = expected_fitness
            
            result = {
                "instance": instance,
                "makespan": makespan,
                "drone_violation": drone_viol,
                "waiting_violation": waiting_viol,
                "fitness": fitness,
                "feasible": (drone_viol < 0.01 and waiting_viol < 0.01)
            }
            
            with open("result.json", "w") as f:
                json.dump(result, f, indent=2)
            
            status = "‚úÖ" if result["feasible"] else "‚ö†Ô∏è"
            print(f"\n{status} {instance}")
            print(f"  Makespan: {makespan:.4f}")
            print(f"  Fitness: {fitness:.4f}")
            print(f"  Feasible: {result['feasible']}")
            
        except Exception as e:
            print(f"‚ùå ERROR {instance}: {e}")
            import traceback
            traceback.print_exc()
            
            with open("result.json", "w") as f:
                json.dump({"instance": instance, "error": str(e)}, f)
        EOF
    
    - name: Upload result
      uses: actions/upload-artifact@v4
      with:
        name: result-${{ matrix.instance }}
        path: |
          result.json
          output.txt
        retention-days: 30

  # ‚úÖ JOB 3: MEDIUM INSTANCES (50 nodes) - V·ª™A PH·∫¢I
  run-medium:
    name: Medium ${{ matrix.instance }}
    needs: compile
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      max-parallel: 8  # V·ª´a ph·∫£i
      matrix:
        instance: [
          "50.10.1", "50.10.2", "50.10.3", "50.10.4",
          "50.20.1", "50.20.2", "50.20.3", "50.20.4",
          "50.30.1", "50.30.2", "50.30.3", "50.30.4",
          "50.40.1", "50.40.2", "50.40.3", "50.40.4"
        ]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download executable
      uses: actions/download-artifact@v4
      with:
        name: multilevel-executable
    
    - name: Run instance
      run: |
        chmod +x multilevel_tabu
        timeout 18m ./multilevel_tabu instances/${{ matrix.instance }}.txt > output.txt 2>&1 || true
        echo "=== EXECUTION COMPLETE ==="
    
    - name: Parse results
      run: |
        python3 <<'EOF'
        import re, json
        
        instance = "${{ matrix.instance }}"
        
        try:
            with open("output.txt", "r") as f:
                content = f.read()
            
            makespan = 0.0
            drone_viol = 0.0
            waiting_viol = 0.0
            fitness = 0.0
            
            lines = content.split('\n')
            for line in reversed(lines):
                if "Makespan:" in line:
                    m = re.search(r'Makespan:\s*([\d.]+)', line)
                    if m: makespan = float(m.group(1))
                elif "Drone violation:" in line:
                    m = re.search(r'Drone violation:\s*([\d.]+)', line)
                    if m: drone_viol = float(m.group(1))
                elif "Waiting violation:" in line:
                    m = re.search(r'Waiting violation:\s*([\d.]+)', line)
                    if m: waiting_viol = float(m.group(1))
                elif "Fitness:" in line and "Route details:" not in content[max(0,content.rfind(line)-200):content.rfind(line)]:
                    m = re.search(r'Fitness:\s*([\d.]+)', line)
                    if m: 
                        fitness = float(m.group(1))
                        break
            
            result = {
                "instance": instance,
                "makespan": makespan,
                "drone_violation": drone_viol,
                "waiting_violation": waiting_viol,
                "fitness": fitness,
                "feasible": (drone_viol < 0.01 and waiting_viol < 0.01)
            }
            
            with open("result.json", "w") as f:
                json.dump(result, f, indent=2)
            
            status = "‚úÖ" if result["feasible"] else "‚ö†Ô∏è"
            print(f"{status} {instance} | Fitness: {fitness:.4f}")
            
        except Exception as e:
            print(f"‚ùå ERROR {instance}: {e}")
            with open("result.json", "w") as f:
                json.dump({"instance": instance, "error": str(e)}, f)
        EOF
    
    - name: Upload result
      uses: actions/upload-artifact@v4
      with:
        name: result-${{ matrix.instance }}
        path: |
          result.json
          output.txt
        retention-days: 30

  # ‚úÖ JOB 4: LARGE INSTANCES (100 nodes) - CH·∫¨M
  run-large:
    name: Large ${{ matrix.instance }}
    needs: compile
    runs-on: ubuntu-latest
    timeout-minutes: 40
    
    strategy:
      fail-fast: false
      max-parallel: 6  # √çt h∆°n v√¨ ch·∫≠m
      matrix:
        instance: [
          "100.10.1", "100.10.2", "100.10.3", "100.10.4",
          "100.20.1", "100.20.2", "100.20.3", "100.20.4",
          "100.30.1", "100.30.2", "100.30.3", "100.30.4",
          "100.40.1", "100.40.2", "100.40.3", "100.40.4"
        ]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download executable
      uses: actions/download-artifact@v4
      with:
        name: multilevel-executable
    
    - name: Run instance
      run: |
        chmod +x multilevel_tabu
        timeout 35m ./multilevel_tabu instances/${{ matrix.instance }}.txt > output.txt 2>&1 || true
        echo "=== EXECUTION COMPLETE ==="
    
    - name: Parse results
      run: |
        python3 <<'EOF'
        import re, json
        
        instance = "${{ matrix.instance }}"
        
        try:
            with open("output.txt", "r") as f:
                content = f.read()
            
            makespan = 0.0
            drone_viol = 0.0
            waiting_viol = 0.0
            fitness = 0.0
            
            lines = content.split('\n')
            for line in reversed(lines):
                if "Makespan:" in line:
                    m = re.search(r'Makespan:\s*([\d.]+)', line)
                    if m: makespan = float(m.group(1))
                elif "Drone violation:" in line:
                    m = re.search(r'Drone violation:\s*([\d.]+)', line)
                    if m: drone_viol = float(m.group(1))
                elif "Waiting violation:" in line:
                    m = re.search(r'Waiting violation:\s*([\d.]+)', line)
                    if m: waiting_viol = float(m.group(1))
                elif "Fitness:" in line and "Route details:" not in content[max(0,content.rfind(line)-200):content.rfind(line)]:
                    m = re.search(r'Fitness:\s*([\d.]+)', line)
                    if m: 
                        fitness = float(m.group(1))
                        break
            
            result = {
                "instance": instance,
                "makespan": makespan,
                "drone_violation": drone_viol,
                "waiting_violation": waiting_viol,
                "fitness": fitness,
                "feasible": (drone_viol < 0.01 and waiting_viol < 0.01)
            }
            
            with open("result.json", "w") as f:
                json.dump(result, f, indent=2)
            
            status = "‚úÖ" if result["feasible"] else "‚ö†Ô∏è"
            print(f"{status} {instance} | Fitness: {fitness:.4f}")
            
        except Exception as e:
            print(f"‚ùå ERROR {instance}: {e}")
            with open("result.json", "w") as f:
                json.dump({"instance": instance, "error": str(e)}, f)
        EOF
    
    - name: Upload result
      uses: actions/upload-artifact@v4
      with:
        name: result-${{ matrix.instance }}
        path: |
          result.json
          output.txt
        retention-days: 30

  # ‚úÖ JOB 5: AGGREGATE
  aggregate:
    name: Aggregate Results
    needs: [run-small, run-medium, run-large]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all results
      uses: actions/download-artifact@v4
      with:
        pattern: result-*
        merge-multiple: true
    
    - name: Create summary
      run: |
        python3 <<'EOF'
        import json, glob, csv
        
        results = []
        for f in sorted(glob.glob("result.json")):
            try:
                with open(f) as file:
                    results.append(json.load(file))
            except: pass
        
        results.sort(key=lambda x: x.get("instance", ""))
        
        # CSV
        with open("all_results.csv", "w", newline="") as f:
            writer = csv.DictWriter(f, fieldnames=["instance", "fitness", "makespan", 
                                                   "drone_violation", "waiting_violation", "feasible"])
            writer.writeheader()
            for r in results:
                if "error" not in r:
                    writer.writerow({
                        "instance": r.get("instance"),
                        "fitness": r.get("fitness", 0),
                        "makespan": r.get("makespan", 0),
                        "drone_violation": r.get("drone_violation", 0),
                        "waiting_violation": r.get("waiting_violation", 0),
                        "feasible": r.get("feasible", False)
                    })
        
        # Summary by size
        print("\n" + "="*80)
        print("üìä EXPERIMENT SUMMARY")
        print("="*80)
        
        for size in ["10", "20", "50", "100"]:
            size_results = [r for r in results if r.get("instance", "").startswith(size + ".") and "error" not in r]
            if size_results:
                feasible = [r for r in size_results if r.get("feasible", False)]
                print(f"\nüì¶ {size} nodes: {len(feasible)}/{len(size_results)} feasible ({len(feasible)/len(size_results)*100:.1f}%)")
                if feasible:
                    fits = [r["fitness"] for r in feasible]
                    print(f"   Best: {min(fits):.4f} | Avg: {sum(fits)/len(fits):.4f} | Worst: {max(fits):.4f}")
        
        # Overall
        total = len([r for r in results if "error" not in r])
        feasible_all = [r for r in results if r.get("feasible", False)]
        print(f"\nüéØ OVERALL: {len(feasible_all)}/{total} feasible ({len(feasible_all)/total*100:.1f}%)")
        
        if feasible_all:
            fits = [r["fitness"] for r in feasible_all]
            print(f"   üèÜ Best: {min(fits):.4f}")
            print(f"   üìä Avg: {sum(fits)/len(fits):.4f}")
            print(f"   üìâ Worst: {max(fits):.4f}")
        
        print("="*80 + "\n")
        EOF
    
    - name: Upload final results
      uses: actions/upload-artifact@v4
      with:
        name: all-results
        path: all_results.csv
        retention-days: 90